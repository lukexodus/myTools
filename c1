#!/usr/bin/env python3
# c1 [Set Cloze Number] - Sets all cloze numbers within the text with the specified number (this is for Anki cloze cards)

# Made for Linux (Windows version commented out below)

import subprocess
import sys
import re

# ========== ORIGINAL WINDOWS VERSION (COMMENTED OUT) ==========
# import pyperclip, sys, re
#
# if len(sys.argv) == 1:
#     sub = "1"
# elif len(sys.argv) == 2:
#     sub = sys.argv[1]
# else:
#     print("Usage: 1c <number to substitute (default is '1')> ")
#     sys.exit()
# text = pyperclip.paste()
# clozeRegex = re.compile(r"(({{c)\d+(::))")
# substitutedText = clozeRegex.sub(f"{{{{c{sub}::", text)
# pyperclip.copy(substitutedText)
# ===============================================================


# ========== LINUX VERSION (using wl-clipboard) ==========
def get_clipboard():
    """Get clipboard content using wl-paste"""
    try:
        result = subprocess.run(['wl-paste'], capture_output=True, text=True, check=True)
        return result.stdout
    except (subprocess.CalledProcessError, FileNotFoundError):
        print("Error: Could not read clipboard. Install wl-clipboard: sudo pacman -S wl-clipboard")
        return ""


def set_clipboard(text):
    """Set clipboard content using wl-copy"""
    try:
        subprocess.run(['wl-copy'], input=text, text=True, check=True)
        return True
    except (subprocess.CalledProcessError, FileNotFoundError):
        print("Error: Could not write to clipboard.")
        return False


if __name__ == "__main__":
    if len(sys.argv) == 1:
        sub = "1"
    elif len(sys.argv) == 2:
        sub = sys.argv[1]
    else:
        print("Usage: c1 <number to substitute (default is '1')>")
        sys.exit()
    
    text = get_clipboard()
    if not text:
        sys.exit(1)
    
    # Strip trailing newline added by wl-paste
    text = text.rstrip('\n')
    
    clozeRegex = re.compile(r"(({{c)\d+(::))")
    substitutedText = clozeRegex.sub(f"{{{{c{sub}::", text)
    
    if set_clipboard(substitutedText):
        print(f"âœ“ Cloze numbers set to {sub}")
    else:
        sys.exit(1)
